#!/bin/bash

# Exit the script on any error
set -e

echo "Starting Docker installation process on Fedora..."

# Step 1: Uninstall old versions (if any)
echo "Uninstalling any old Docker versions..."
sudo dnf remove -y docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-selinux \
                  docker-engine-selinux \
                  docker-engine || true

# Step 2: Install dependencies
echo "Installing required dependencies..."
sudo dnf -y install dnf-plugins-core

# Step 3: Set up Docker repository
echo "Setting up Docker repository..."
sudo dnf-3 config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo

# Step 4: Install Docker Engine
echo "Installing Docker Engine..."
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

echo "Adding current user to the Docker group for non-root access..."
sudo usermod -aG docker "$(whoami)"


# {{ $nvidia := output "sh" "-c" "lspci -k 2>/dev/null | grep -iq nvidia && echo 'yes' || echo 'no'" | trim -}}
# {{ if eq $nvidia "yes" -}}
echo "Configuring NVIDIA settings for Docker..."
curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
  sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo

# export NVIDIA_CONTAINER_TOOLKIT_VERSION=1.17.8-1
sudo dnf install -y nvidia-container-toolkit

echo "Docker NVIDIA runtime configuration..."
sudo nvidia-ctk runtime configure --runtime=docker
# {{ end }}

# Step 5: Enable and start Docker service
echo "Enabling and starting Docker service..."
sudo systemctl enable --now docker

# {{/* vim: set ft=sh: */}}
